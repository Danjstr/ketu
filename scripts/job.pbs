#!/bin/bash
#PBS -l nodes=4:ppn=12
#PBS -l walltime=48:00:00
#PBS -l mem=48GB
#PBS -N turnstile
#PBS -M danfm@nyu.edu
#PBS -j oe
Â 
module purge
export PATH="$HOME/miniconda/bin:$PATH"

# Needed environment variables.
export KPLR_ROOT=$SCRATCH/kplr
export TURNSTILE_PATH=$SCRATCH/turnstile/cache

# Locations.
SRCDIR=$HOME/projects/turnstile
RUNDIR=$SCRATCH/turnstile/run-${PBS_JOBID/.*}
PROFILEDIR=$RUNDIR/profile
mkdir -p $RUNDIR
cd $RUNDIR

# Set up and start the IPython cluster.
cp -r $HOME/.ipython/profile_mpi $PROFILEDIR
ipcluster start -n $PBS_NP --profile-dir=$PROFILEDIR

# Run the analysis.
python $SRCDIR/scripts/injections.py $PROFILEDIR &> output.log

# Shut the cluster down.
ipcluster stop  --profile-dir=$PROFILEDIR
